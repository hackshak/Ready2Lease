{% extends "sidebar.html" %}
{% load static %}

{% block content %}

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<style>
:root{
  --bg:#0b1020;
  --panel:#111a33;
  --panel2:#0f1730;
  --text:#e9eefc;
  --muted:#a9b4d6;
  --border:rgba(255,255,255,.08);
  --shadow:0 14px 30px rgba(0,0,0,.35);
  --radius:18px;
  --primary:#6c7dff;
  --primary2:#8b5cf6;
  --good:#28d17c;
}

.ai-container{
  padding:40px;
  max-width:1300px;
  margin:auto;
  color:var(--text);
}

.ai-title{
  font-size:24px;
  font-weight:700;
  margin-bottom:25px;
}

.ai-grid{
  display:grid;
  grid-template-columns: 320px 1fr;
  gap:20px;
}

/* LEFT PANEL */
.assessment-list{
  display:flex;
  flex-direction:column;
  gap:12px;
}

.assessment-box{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:14px;
  padding:15px;
  cursor:pointer;
  transition:all .2s ease;
}

.assessment-box:hover{
  border-color:var(--primary);
}

.assessment-box.active{
  border:2px solid var(--primary);
  background:rgba(108,125,255,.15);
}

.assessment-box h4{
  margin:0;
  font-size:14px;
}

.assessment-meta{
  font-size:12px;
  color:var(--muted);
  margin-top:6px;
}

/* RIGHT PANEL */
.card{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:20px;
}

.score-ring{
  width:110px;
  height:110px;
  border-radius:50%;
  margin:15px auto;
  display:flex;
  align-items:center;
  justify-content:center;
  background:
    radial-gradient(circle at center, #111a33 60%, transparent 61%),
    conic-gradient(var(--good) 0deg, var(--good) var(--deg), rgba(255,255,255,.1) var(--deg));
}

.score-ring b{
  font-size:26px;
}

.badge{
  display:inline-block;
  padding:6px 12px;
  border-radius:999px;
  background:rgba(255,255,255,.08);
  font-size:12px;
  margin-top:8px;
}

.chat-box{
  height:420px;
  overflow-y:auto;
  padding:15px;
  background:var(--panel2);
  border-radius:14px;
  border:1px solid var(--border);
  margin-bottom:12px;
}

.chat-msg{
  margin-bottom:12px;
  display:flex;
}

.chat-msg.user{
  justify-content:flex-end;
}

.chat-bubble{
  padding:10px 14px;
  border-radius:14px;
  max-width:75%;
  font-size:13px;
  line-height:1.5;
}

.chat-msg.user .chat-bubble{
  background:linear-gradient(135deg,var(--primary),var(--primary2));
}

.chat-msg.assistant .chat-bubble{
  background:rgba(255,255,255,.08);
}

.chat-input-wrap{
  display:flex;
  gap:10px;
}

.chat-input-wrap input{
  flex:1;
  padding:12px;
  border-radius:12px;
  border:1px solid var(--border);
  background:#0f1730;
  color:white;
}

.chat-input-wrap button{
  padding:12px 18px;
  border-radius:12px;
  border:0;
  cursor:pointer;
  background:linear-gradient(135deg,var(--primary),var(--primary2));
  color:white;
  font-weight:600;
}

@media(max-width:1000px){
  .ai-grid{
    grid-template-columns:1fr;
  }
}

.typing{
  display:flex;
  gap:5px;
  align-items:center;
}

.dot{
  width:6px;
  height:6px;
  background:white;
  border-radius:50%;
  animation:blink 1.4s infinite both;
}

.dot:nth-child(2){
  animation-delay: .2s;
}

.dot:nth-child(3){
  animation-delay: .4s;
}

@keyframes blink{
  0%{ opacity:.2; }
  20%{ opacity:1; }
  100%{ opacity:.2; }
}


.chat-bubble h1,
.chat-bubble h2,
.chat-bubble h3 {
  margin: 10px 0 6px;
  font-weight: 600;
}

.chat-bubble ul {
  padding-left: 18px;
  margin: 6px 0;
}

.chat-bubble li {
  margin-bottom: 4px;
}

.chat-bubble strong {
  font-weight: 600;
}

.chat-bubble p {
  margin: 6px 0;
}
</style>

<div class="ai-container">

  <div class="ai-title">AI Assistant For Your Readiness Score</div>

  <div class="ai-grid">

    <!-- LEFT SIDE: ASSESSMENTS -->
    <div class="assessment-list" id="assessmentList">
      <!-- Assessments loaded dynamically -->
    </div>

    <!-- RIGHT SIDE: CHAT -->
    <div class="card">
      <h3 style="margin-top:0;">Selected Assessment</h3>

      <div class="score-ring" id="scoreRing" style="--deg:0deg;">
        <b id="scoreValue">0</b>
      </div>

      <div style="text-align:center;">
        <div class="badge" id="riskBadge">Risk: â€”</div>
      </div>

      <hr style="border-color:rgba(255,255,255,.08); margin:20px 0;">

      <h3>Chat With AI</h3>

      <div id="chatBox" class="chat-box"></div>

      <div class="chat-input-wrap">
        <input type="text" id="chatInput" placeholder="Ask about this assessment...">
        <button onclick="sendMessage()">Send</button>
      </div>
    </div>

  </div>

</div>





<script>
let selectedAssessmentId = null;
let selectedAssessmentData = null;
let chatHistory = [];
let isTyping = false;

function getCSRFToken() {
  const name = "csrftoken";
  const cookies = document.cookie.split(";");
  for (let cookie of cookies) {
    cookie = cookie.trim();
    if (cookie.startsWith(name + "=")) {
      return decodeURIComponent(cookie.substring(name.length + 1));
    }
  }
  return null;
}

async function loadAssessments(){
  const res = await fetch("/ai-assist/assessments/", {credentials:"same-origin"});
  if(!res.ok) return;

  const data = await res.json();
  const list = document.getElementById("assessmentList");
  list.innerHTML = "";

  data.forEach(a=>{
    const box = document.createElement("div");
    box.className = "assessment-box";
    box.innerHTML = `
      <h4>${a.suburb || "Assessment"}</h4>
      <div class="assessment-meta">
        Score: ${a.readiness_score} <br>
        Risk: ${a.risk_level}
      </div>
    `;

    box.onclick = () => selectAssessment(a, box);
    list.appendChild(box);
  });
}

function selectAssessment(assessment, element){
  selectedAssessmentId = assessment.id;
  selectedAssessmentData = assessment;

  document.querySelectorAll(".assessment-box")
    .forEach(b=>b.classList.remove("active"));
  element.classList.add("active");

  document.getElementById("scoreValue").innerText = assessment.readiness_score;
  const deg = (assessment.readiness_score / 100) * 360;
  document.getElementById("scoreRing")
    .style.setProperty("--deg", deg+"deg");
  document.getElementById("riskBadge")
    .innerText = "Risk: " + assessment.risk_level;

  chatHistory = [];
  renderChat();
}

function renderChat(){
  const box = document.getElementById("chatBox");
  box.innerHTML = "";

  chatHistory.forEach(m=>{
    box.innerHTML += `
      <div class="chat-msg ${m.role}">
        <div class="chat-bubble">
          ${marked.parse(m.content)}
        </div>
      </div>
    `;
  });

  if(isTyping){
    box.innerHTML += `
      <div class="chat-msg assistant">
        <div class="chat-bubble typing">
          <span class="dot"></span>
          <span class="dot"></span>
          <span class="dot"></span>
        </div>
      </div>
    `;
  }

  box.scrollTop = box.scrollHeight;
}

async function sendMessage(){
  if(!selectedAssessmentId){
    alert("Please select an assessment first.");
    return;
  }

  const input = document.getElementById("chatInput");
  const message = input.value.trim();
  if(!message) return;

  input.value = "";

  chatHistory.push({
    role: "user",
    content: message
  });

  isTyping = true;
  renderChat();

  try{
    const res = await fetch("/ai-assist/chat/",{
      method:"POST",
      credentials:"same-origin",
      headers:{
        "Content-Type":"application/json",
        "X-CSRFToken": getCSRFToken()
      },
      body:JSON.stringify({
        message: message,
        assessment_id: selectedAssessmentId,
        history: chatHistory
      })
    });

    const data = await res.json();

    isTyping = false;

    chatHistory.push({
      role: "assistant",
      content: data.reply
    });

    renderChat();

  }catch(err){
    isTyping = false;
    chatHistory.push({
      role: "assistant",
      content: "Something went wrong. Please try again."
    });
    renderChat();
  }
}

function quickAsk(text){
  document.getElementById("chatInput").value = text;
  sendMessage();
}

document.addEventListener("DOMContentLoaded", ()=>{
  loadAssessments();
});
</script>

{% endblock %}