{% extends "sidebar.html" %}
{% load static %}

{% block content %}

<title>ReadyRent Dashboard</title>

<style>
/* (Your CSS unchanged — kept exactly same for safety) */
:root{
  --bg:#0b1225;
  --panel:#121c36;
  --panel2:#162246;
  --text:#e8edff;
  --muted:#9fb0ff;
  --border:rgba(255,255,255,.08);
  --radius:20px;
  --shadow:0 20px 40px rgba(0,0,0,.35);
  --good:#28d17c;
  --mid:#f7c948;
  --bad:#ff5a7a;
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui;
  background:linear-gradient(180deg,#0a0f1f,#0d1631);
  color:var(--text);
}

.wrapper{
  padding:30px;
  display:grid;
  grid-template-columns: 3fr 1.2fr;
  gap:25px;
}

.left{display:flex;flex-direction:column;gap:20px;}

.right{
  background:linear-gradient(180deg,var(--panel),var(--panel2));
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:20px;
  box-shadow:var(--shadow);
  max-height:85vh;
  overflow-y:auto;
}

.card{
  background:linear-gradient(180deg,var(--panel),var(--panel2));
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:20px;
  box-shadow:var(--shadow);
}

.card h2{margin:0 0 15px;font-size:15px;font-weight:600;}

.score-wrap{display:flex;align-items:center;gap:25px;}

.score-ring{
  width:110px;
  height:110px;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
}

.score-ring b{font-size:28px}

.kpi-grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:15px;
  margin-top:20px;
}

.kpi{
  background:rgba(255,255,255,.05);
  border-radius:16px;
  padding:15px;
  border:1px solid var(--border);
}

.kpi span{font-size:12px;color:var(--muted);}
.kpi strong{display:block;margin-top:5px;}

.bar-row{
  display:grid;
  grid-template-columns:160px 1fr 50px;
  gap:12px;
  align-items:center;
  margin-bottom:12px;
}

.bar-track{
  height:10px;
  border-radius:20px;
  background:rgba(255,255,255,.08);
  overflow:hidden;
}

.bar-fill{
  height:100%;
  width:0%;
  border-radius:20px;
  background:linear-gradient(90deg,var(--good),#6c7dff);
  transition:width .4s ease;
}

.item-box{
  background:rgba(255,255,255,.05);
  border-radius:16px;
  padding:14px;
  margin-bottom:12px;
  border:1px solid var(--border);
}

.priority{
  font-size:11px;
  padding:4px 10px;
  border-radius:20px;
  margin-top:6px;
  display:inline-block;
}

.priority.high{background:rgba(255,90,122,.2); color:var(--bad);}
.priority.medium{background:rgba(247,201,72,.2); color:var(--mid);}
.priority.low{background:rgba(40,209,124,.2); color:var(--good);}

.assessment-item{
  background:rgba(255,255,255,.05);
  border:1px solid var(--border);
  border-radius:16px;
  padding:14px;
  margin-top:15px;
  transition:all .25s ease;
}

.assessment-item.active{
  border:1px solid #6c7dff;
  background:rgba(108,125,255,.1);
}

.assessment-item button{
  margin-top:8px;
  width:100%;
  padding:8px;
  border-radius:10px;
  border:none;
  cursor:pointer;
  background:linear-gradient(135deg,#6c7dff,#8b5cf6);
  color:white;
}
</style>

<div class="wrapper">
  <div class="left">

    <div class="card">
      <h2>Readiness Snapshot</h2>

      <div class="score-wrap">
        <div class="score-ring" id="scoreRing">
          <b id="scoreValue">—</b>
        </div>
        <div>
          <div id="statusText"></div>
        </div>
      </div>

      <div class="kpi-grid">
        <div class="kpi"><span>Last Assessment</span><strong id="lastAssessment">—</strong></div>
        <div class="kpi"><span>Score Trend</span><strong id="scoreTrend">—</strong></div>
        <div class="kpi"><span>Income to Rent</span><strong id="incomeRent">—</strong></div>
        <div class="kpi"><span>Risk Level</span><strong id="riskLevel">—</strong></div>
      </div>
    </div>

    <div class="card"><h2>Category Breakdown</h2><div id="breakdownList"></div></div>
    <div class="card"><h2>Gap Analysis</h2><div id="gapsList"></div></div>
    <div class="card"><h2>Improvement Recommendations</h2><div id="recommendationsList"></div></div>

  </div>

  <div class="right">
    <h2>Previous Assessments</h2>
    <div id="assessmentList"></div>
  </div>
</div>







<script>
function $(id){return document.getElementById(id);}
function clamp(n,min,max){return Math.max(min,Math.min(max,n));}

let scoreInterval=null;
let currentController=null;
let hasLoadedInitial=false;

/* Animate Score */
function animateScore(newScore){
  if(scoreInterval) clearInterval(scoreInterval);

  const el=$("scoreValue");
  el.textContent="0";

  let current=0;
  const step=Math.max(1,Math.ceil(newScore/25));

  scoreInterval=setInterval(()=>{
    current+=step;
    if(current>=newScore){
      current=newScore;
      clearInterval(scoreInterval);
    }
    el.textContent=current;
  },15);
}

/* Load All Assessments */
async function loadAssessments(){

  try{
    const res=await fetch("/api/detailed-readiness/",{
      credentials:"same-origin"
    });

    if(!res.ok){
      console.error("Failed to fetch assessments");
      return;
    }

    const data=await res.json();
    const list=$("assessmentList");
    list.innerHTML="";

    if(!data.previous_assessments?.length){
      list.innerHTML="<p style='color:#9fb0ff'>No assessments found.</p>";
      return;
    }

    data.previous_assessments.forEach(a=>{
      const div=document.createElement("div");
      div.className="assessment-item";
      div.dataset.id=a.id;

      div.innerHTML=`
        <strong>Score: ${a.score}</strong>
        <div style="font-size:12px;color:#9fb0ff">${a.created_at}</div>
        <button type="button">Detailed Analysis</button>
      `;

      div.querySelector("button").addEventListener("click",()=>{
        loadDetailed(a.id);
      });

      list.appendChild(div);
    });

    // Load first only once
    if(!hasLoadedInitial){
      hasLoadedInitial=true;
      loadDetailed(data.previous_assessments[0].id);
    }

  }catch(e){
    console.error(e);
  }
}

/* Load Single Assessment */
async function loadDetailed(id){

  // Highlight active
  document.querySelectorAll(".assessment-item")
    .forEach(el=>{
      el.classList.toggle("active",Number(el.dataset.id)===Number(id));
    });

  if(currentController){
    currentController.abort();
  }

  currentController=new AbortController();

  try{

    // ✅ FIXED URL (Query Param, not path param)
    const res=await fetch(
      `/api/detailed-readiness/?assessment_id=${id}`,
      {
        credentials:"same-origin",
        signal: currentController.signal
      }
    );

    if(!res.ok){
      console.error("Failed to load detailed assessment");
      return;
    }

    const data=await res.json();
    const score=data.score ?? 0;

    animateScore(score);

    const deg=Math.round(score/100*360);
    const color=
      score>=80?"var(--good)":
      score>=55?"var(--mid)":
      "var(--bad)";

    $("scoreRing").style.background=
      `radial-gradient(circle,#121c36 60%,transparent 61%),
       conic-gradient(${color} 0deg,${color} ${deg}deg,rgba(255,255,255,.08) ${deg}deg)`;

    $("riskLevel").textContent=data.risk_level ?? "—";

    $("lastAssessment").textContent=
      data.last_assessment
        ? new Date(data.last_assessment).toLocaleDateString()
        : "—";

    if(data.score_prev !== undefined){
      const diff=score-data.score_prev;
      $("scoreTrend").textContent=
        diff>0?`+${diff}`:diff;
    } else {
      $("scoreTrend").textContent="—";
    }

    $("incomeRent").textContent=
      data.income_weekly && data.target_rent_weekly
        ? (data.income_weekly/data.target_rent_weekly).toFixed(2)
        : "—";

    $("statusText").textContent=
      score>=80?"Strong Approval Odds":
      score>=55?"Moderate Competitiveness":
      "High Risk";

    /* Breakdown */
    const br=$("breakdownList");
    br.innerHTML="";
    data.breakdown?.forEach(cat=>{
      const row=document.createElement("div");
      row.className="bar-row";
      row.innerHTML=`
        <div>${cat.key.replace(/_/g," ")}</div>
        <div class="bar-track"><div class="bar-fill"></div></div>
        <div>${cat.value}%</div>
      `;
      br.appendChild(row);

      requestAnimationFrame(()=>{
        row.querySelector(".bar-fill").style.width=
          clamp(cat.value,0,100)+"%";
      });
    });

    /* Gaps */
    const gaps=$("gapsList");
    gaps.innerHTML="";
    if(data.gaps && Object.keys(data.gaps).length>0){
      Object.entries(data.gaps).forEach(([k,v])=>{
        const div=document.createElement("div");
        div.className="item-box";
        div.innerHTML=`
          <strong>${k.replace(/_/g," ")}</strong>
          <p style="color:#9fb0ff;font-size:13px">${v}</p>
        `;
        gaps.appendChild(div);
      });
    } else {
      gaps.innerHTML="<p style='color:#9fb0ff'>No gaps detected.</p>";
    }

    /* Recommendations */
    const rec=$("recommendationsList");
    rec.innerHTML="";
    if(data.recommendations?.length){
      data.recommendations.forEach(r=>{
        const div=document.createElement("div");
        div.className="item-box";
        div.innerHTML=`
          <strong>${r.category.replace(/_/g," ")}</strong>
          <p style="color:#9fb0ff;font-size:13px">${r.suggestion}</p>
          <span class="priority ${r.priority}">
            ${r.priority.toUpperCase()}
          </span>
        `;
        rec.appendChild(div);
      });
    } else {
      rec.innerHTML="<p style='color:#9fb0ff'>No recommendations available.</p>";
    }

  }catch(e){
    if(e.name==="AbortError") return;
    console.error(e);
  }
}

document.addEventListener("DOMContentLoaded",loadAssessments);
</script>

{% endblock %}