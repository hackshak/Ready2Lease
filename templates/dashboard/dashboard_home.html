{% extends "sidebar.html" %}
{% load static %}
{% block content %}

<title>Rental Readiness Dashboard â€” Home</title>

<style>
:root{
  --bg:#0b1020;
  --panel:#111a33;
  --text:#e9eefc;
  --muted:#a9b4d6;
  --border:rgba(255,255,255,.10);
  --shadow:0 14px 30px rgba(0,0,0,.35);
  --radius:18px;

  --good:#28d17c;
  --mid:#f7c948;
  --bad:#ff5a7a;

  --primary:#6c7dff;
  --primary2:#8b5cf6;
}

body{
  margin:0;
  font-family: ui-sans-serif,system-ui;
  background: radial-gradient(1000px 600px at 10% -10%, rgba(108,125,255,.25), transparent 60%), var(--bg);
  color:var(--text);
}

.wrap{margin:0 auto;padding:24px 18px 60px;max-width:1200px;}

.card{
  margin-top:15px;
  border:1px solid var(--border);
  background: rgba(17,26,51,.75);
  backdrop-filter: blur(10px);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding:18px;
  margin-bottom:18px;
}

h2{margin:0 0 12px;font-size:15px;}
.sub{color:var(--muted);font-size:12px;}

.hero{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:20px;
}
@media(max-width:900px){
  .hero{grid-template-columns:1fr;}
}

.kpi{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px;}
.item{background:rgba(255,255,255,.05);padding:12px;border-radius:14px;border:1px solid var(--border);margin-top:5px}
.label{font-size:11px;color:var(--muted);}
.value{font-size:15px;font-weight:700;margin-top:5px;}

/* =========================
   DARK SELECT DROPDOWN FIX
========================= */

select{
  background: rgba(17,26,51,.85);
  color: var(--text);
  border:1px solid var(--border);
  padding:8px 12px;
  border-radius:12px;
  font-size:13px;
  outline:none;
  appearance:none;
  -webkit-appearance:none;
  -moz-appearance:none;
  cursor:pointer;
}

/* Dropdown options */
select option{
  background: #111a33;
  color: #e9eefc;
}

/* Hover state (where supported) */
select option:hover{
  background: rgba(108,125,255,.2);
}

/* Focus */
select:focus{
  border-color: var(--primary);
  box-shadow: 0 0 0 2px rgba(108,125,255,.3);
}

.ring{
  width:140px;height:140px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  margin:10px auto;
  background:
    radial-gradient(circle at center,#111a33 60%,transparent 61%),
    conic-gradient(var(--good) 0deg,var(--good) var(--deg),rgba(255,255,255,.08) var(--deg));
}
.ring.low{background:
  radial-gradient(circle at center,#111a33 60%,transparent 61%),
  conic-gradient(var(--bad) 0deg,var(--bad) var(--deg),rgba(255,255,255,.08) var(--deg));
}
.ring.mid{background:
  radial-gradient(circle at center,#111a33 60%,transparent 61%),
  conic-gradient(var(--mid) 0deg,var(--mid) var(--deg),rgba(255,255,255,.08) var(--deg));
}

.track{height:8px;background:rgba(255,255,255,.08);border-radius:999px;}
.fill{height:100%;border-radius:999px;background:linear-gradient(90deg,var(--good),var(--primary));}

.riskItem{
  background:rgba(255,90,122,.08);
  border:1px solid rgba(255,90,122,.2);
  padding:10px;border-radius:12px;margin-bottom:8px;
  font-size:12px;
}

.nextAction{
  background:linear-gradient(135deg,rgba(108,125,255,.15),rgba(139,92,246,.12));
  border:1px solid rgba(255,255,255,.15);
  padding:16px;border-radius:var(--radius);
}
</style>

<div class="wrap">

<div class="card">
  <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;">
    <div>
      <h2 id="welcomeLine">Hi â€”</h2>
      <div class="sub">Track and improve your rental approval strength.</div>
    </div>

    <div>
      <div class="sub">Assessment</div>
      <select id="assessmentSelect"></select>
    </div>
  </div>
</div>

<div class="hero">

<div class="card">
  <h2>Readiness Score</h2>

  <div class="ring" id="scoreRing" style="--deg:0deg">
    <div style="text-align:center">
      <div style="font-size:28px;font-weight:700" id="scoreValue">â€”</div>
      <div style="font-size:11px;color:var(--muted)">/ 100</div>
    </div>
  </div>

  <div class="kpi">
    <div class="item">
      <div class="label">Approval Probability</div>
      <div class="value" id="approvalProb">â€”</div>
    </div>
    <div class="item">
      <div class="label">Competitiveness Rank</div>
      <div class="value" id="competRank">â€”</div>
    </div>
  </div>
</div>

<div class="nextAction" id="nextActionCard">
  <h2>ðŸ”¥ Next Best Action</h2>
  <div id="nextActionContent">â€”</div>
</div>

</div>

<!-- {% if is_premium %} -->
<div class="card">
  <h2>âš  Risk Signals</h2>
  <div id="riskSignals"></div>
</div>

<div class="card">
  <h2>Category Breakdown</h2>
  <div id="breakdownList"></div>
</div>

<div class="card">
  <h2>Improvement Plan</h2>
  <div id="stepsList"></div>
</div>

<div class="card">
  <h2>Area Snapshot</h2>
  <div class="kpi">
    <div class="item"><div class="label">Postcode</div><div class="value" id="postcodeVal"></div></div>
    <div class="item"><div class="label">Avg Rent</div><div class="value" id="avgRent"></div></div>
    <div class="item"><div class="label">Target Rent</div><div class="value" id="targetRent"></div></div>
    <div class="item"><div class="label">Income Weekly</div><div class="value" id="incomeWeekly"></div></div>
  </div>
</div>
<!-- {% endif %} -->


</div>






<script>
function $(id){return document.getElementById(id);}
function formatAUD(n){return "$"+Math.round(n||0).toLocaleString();}
function clamp(n,min,max){return Math.max(min,Math.min(max,n));}

let isLoading = false;

async function loadAssessment(id=null){
  if(isLoading) return;
  isLoading = true;

  let url='/api/free-readiness/';
  if(id) url+=`?assessment_id=${id}`;

  try{
    const res=await fetch(url,{credentials:'same-origin'});
    if(!res.ok){
      // alert("Failed to load assessment");
      return;
    }
    const data=await res.json();
    render(data);
  }catch(e){
    console.error(e);
  }finally{
    isLoading = false;
  }
}

function render(data){

  $("welcomeLine").textContent="Hi "+data.user_name+" ðŸ‘‹";

  const score=clamp(data.score,0,100);
  $("scoreValue").textContent=score;
  $("scoreRing").style.setProperty("--deg",(score/100)*360+"deg");

  if(score<40) $("scoreRing").className="ring low";
  else if(score<70) $("scoreRing").className="ring mid";
  else $("scoreRing").className="ring";

  $("approvalProb").textContent=data.approval_probability+"%";
  $("competRank").textContent="Top "+data.competitiveness_percentile+"%";

  $("postcodeVal").textContent=data.postcode;
  $("avgRent").textContent=formatAUD(data.avg_rent_weekly);
  $("targetRent").textContent=formatAUD(data.target_rent_weekly);
  $("incomeWeekly").textContent=formatAUD(data.income_weekly);

  if(data.next_best_action){
    $("nextActionContent").innerHTML="<b>"+data.next_best_action.title+"</b><br>"+data.next_best_action.suggestion;
  }

  const riskEl=$("riskSignals");
  riskEl.innerHTML="";
  if(data.risk_signals.length===0){
    riskEl.innerHTML="<div class='sub'>No major risks detected.</div>";
  }else{
    data.risk_signals.forEach(r=>{
      const div=document.createElement("div");
      div.className="riskItem";
      div.innerHTML="<b>"+r.category.replace("_"," ")+"</b><br>"+r.reason;
      riskEl.appendChild(div);
    });
  }

  const breakEl=$("breakdownList");
  breakEl.innerHTML="";
  data.breakdown.forEach(b=>{
    const div=document.createElement("div");
    div.innerHTML=
      "<div style='font-size:12px;margin-bottom:4px'>"+
      b.key.replace("_"," ")+" ("+b.value+")</div>"+
      "<div class='track'><div class='fill' style='width:"+b.value+"%'></div></div><br>";
    breakEl.appendChild(div);
  });

  const stepsEl=$("stepsList");
  stepsEl.innerHTML="";
  data.steps.forEach(s=>{
    const div=document.createElement("div");
    div.className="item";
    div.innerHTML="<b>"+s.title+"</b><br>"+s.desc;
    stepsEl.appendChild(div);
  });

  populateAssessmentDropdown(data.previous_assessments,data.assessment_id);
}

function populateAssessmentDropdown(list,activeId){
  const select=$("assessmentSelect");

  // Clear only once
  if(select.options.length !== list.length){
    select.innerHTML="";
    list.forEach(a=>{
      const opt=document.createElement("option");
      opt.value=a.id;
      opt.textContent=a.created_at+" â€¢ Score "+a.score;
      select.appendChild(opt);
    });

    select.addEventListener("change",function(){
      loadAssessment(this.value);
    });
  }

  select.value = activeId;
}

document.addEventListener("DOMContentLoaded",()=>loadAssessment());
</script>

{% endblock %}