{% extends "sidebar.html" %}
{% load static %}
{% block content %}

<style>
/* =========================================
   ACTION PLAN PAGE (MULTI-ASSESSMENT READY)
========================================= */

.action-plan-container{
    padding:50px 40px;
    color:#e9eefc;
    max-width:1200px;
}

.ap-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:35px;
}

.ap-title{
    font-size:24px;
    font-weight:700;
}

.ap-btn{
    border:0;
    cursor:pointer;
    font-size:13px;
    padding:10px 16px;
    border-radius:14px;
    font-weight:600;
    background:linear-gradient(135deg,#6c7dff,#8b5cf6);
    color:#fff;
    box-shadow:0 10px 20px rgba(108,125,255,.25);
    transition:.2s ease;
}

.ap-btn:hover{
    transform:translateY(-2px);
    box-shadow:0 14px 26px rgba(108,125,255,.35);
}

.ap-selector{margin-bottom:30px;}

.ap-selector select{
    background:#0f1730;
    border:1px solid rgba(255,255,255,.12);
    color:#fff;
    padding:10px 14px;
    border-radius:12px;
    font-size:13px;
}

.ap-grid{
    display:grid;
    grid-template-columns:1.3fr 1fr;
    gap:28px;
}

.ap-card{
    background:rgba(17,26,51,.85);
    border:1px solid rgba(255,255,255,.08);
    border-radius:20px;
    padding:30px;
    box-shadow:0 18px 40px rgba(0,0,0,.45);
}

.ap-ring{
    width:140px;
    height:140px;
    margin:30px auto;
    border-radius:50%;
    display:flex;
    align-items:center;
    justify-content:center;
    transition:.4s ease;
}

.ap-ring.good{
    background:
        radial-gradient(circle at center,#111a33 60%,transparent 61%),
        conic-gradient(#28d17c 0deg,#28d17c var(--deg),rgba(255,255,255,.1) var(--deg));
}

.ap-ring.mid{
    background:
        radial-gradient(circle at center,#111a33 60%,transparent 61%),
        conic-gradient(#f7c948 0deg,#f7c948 var(--deg),rgba(255,255,255,.1) var(--deg));
}

.ap-ring.bad{
    background:
        radial-gradient(circle at center,#111a33 60%,transparent 61%),
        conic-gradient(#ff5a7a 0deg,#ff5a7a var(--deg),rgba(255,255,255,.1) var(--deg));
}

.ap-ring b{font-size:32px;}

.ap-steps{
    display:flex;
    flex-direction:column;
    gap:18px;
    margin-top:10px;
}

.ap-step{
    display:flex;
    justify-content:space-between;
    align-items:center;
    background:rgba(255,255,255,.05);
    padding:18px;
    border-radius:16px;
    border:1px solid rgba(255,255,255,.08);
}

.ap-step h4{margin:0;font-size:15px;}
.ap-step p{margin:6px 0 0;font-size:13px;color:#a9b4d6;}

.ap-impact{
    margin-top:8px;
    display:inline-block;
    font-size:11px;
    background:rgba(40,209,124,.18);
    color:#28d17c;
    padding:5px 10px;
    border-radius:999px;
    font-weight:700;
}

.ap-empty{
    text-align:center;
    padding:40px;
    color:#a9b4d6;
}

/* =========================================
   MODAL
========================================= */

.ap-modal{
    position:fixed;
    inset:0;
    background:rgba(5,10,25,.85);
    backdrop-filter:blur(8px);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:3000;
}

.ap-modal-content{
    background:linear-gradient(145deg,#121b35,#0f1730);
    padding:35px;
    border-radius:22px;
    width:95%;
    max-width:520px;
    border:1px solid rgba(255,255,255,.08);
    box-shadow:0 30px 60px rgba(0,0,0,.6);
    animation:fadeIn .25s ease;
}

@keyframes fadeIn{
    from{opacity:0;transform:translateY(15px);}
    to{opacity:1;transform:translateY(0);}
}

.ap-modal-content h3{
    margin-top:0;
    margin-bottom:15px;
    font-size:18px;
    color:white;
}

.ap-modal-content input[type="file"]{
    width:100%;
    background:rgba(255,255,255,.05);
    border:1px solid rgba(255,255,255,.1);
    color:#fff;
    padding:12px 14px;
    border-radius:14px;
    font-size:13px;
    margin-bottom:20px;
}

.modal-actions{
    display:flex;
    justify-content:flex-end;
    gap:12px;
}

/* SUCCESS */

.ap-success{
    text-align:center;
    padding:25px 10px;
}

.ap-success-icon{
    font-size:48px;
    margin-bottom:10px;
    color:#28d17c;
}

.ap-success h3{
    margin-bottom:10px;
}

.ap-success p{
    font-size:13px;
    color:#a9b4d6;
    margin-bottom:20px;
}

@media(max-width:1000px){
    .ap-grid{grid-template-columns:1fr;}
}
</style>

<div class="action-plan-container">

<form style="display:none;">{% csrf_token %}</form>

<div class="ap-header">
    <div class="ap-title">Your Premium Action Plan</div>
    <button class="ap-btn" type="button" id="refreshBtn">Refresh</button>
</div>

<div class="ap-selector">
    <label>Select Assessment:</label><br>
    <select id="assessmentSelect"></select>
</div>

<div class="ap-grid">

    <div class="ap-card">
        <h3>Score Improvement</h3>
        <div class="ap-ring good" id="scoreRing" style="--deg:0deg;">
            <b id="finalScore">0</b>
        </div>
        <p style="text-align:center;color:#a9b4d6;font-size:14px;">
            Complete tasks to increase your rental competitiveness.
        </p>
    </div>

    <div class="ap-card">
        <h3>Recommended Actions</h3>
        <div id="apSteps" class="ap-steps"></div>
    </div>

</div>
</div>

<div id="apModal" class="ap-modal">
  <div class="ap-modal-content">
    <div style="text-align:right;cursor:pointer;color:white;" onclick="closeModal()">âœ•</div>
    <div id="apModalContent"></div>
  </div>
</div>

<script>
let selectedAssessment=null;

function getCSRFToken(){
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
}

/* SUCCESS */
function showSuccess(points){
    const content=document.getElementById("apModalContent");
    content.innerHTML=`
        <div class="ap-success">
            <div class="ap-success-icon">âœ“</div>
            <h3>Task Completed!</h3>
            <p>You earned <strong>+${points} points</strong>.</p>
            <div class="modal-actions">
                <button class="ap-btn" onclick="closeModal()">Continue</button>
            </div>
        </div>
    `;
}

async function loadAssessments(){
    const res=await fetch("/api/detailed-readiness/",{credentials:"same-origin"});
    if(!res.ok) return;

    const data=await res.json();
    const select=document.getElementById("assessmentSelect");
    select.innerHTML="";

    if(!data.previous_assessments?.length){
        select.innerHTML="<option>No Assessments Found</option>";
        return;
    }

    data.previous_assessments.forEach(a=>{
        const opt=document.createElement("option");
        opt.value=a.id;
        opt.textContent=`${a.created_at} (Score: ${a.score})`;
        select.appendChild(opt);
    });

    selectedAssessment=data.previous_assessments[0].id;
    select.value=selectedAssessment;

    select.onchange=function(){
        selectedAssessment=this.value;
        loadTasks();
    };

    loadTasks();
}

async function loadTasks(){
    if(!selectedAssessment) return;

    const res=await fetch(`/tasks/${selectedAssessment}/`,{credentials:"same-origin"});
    if(!res.ok) return;

    const data=await res.json();
    const score=data.final_score||0;

    const ring=document.getElementById("scoreRing");
    ring.className="ap-ring "+(score>=80?"good":score>=55?"mid":"bad");

    document.getElementById("finalScore").innerText=score;
    ring.style.setProperty("--deg",(score/100)*360+"deg");

    const container=document.getElementById("apSteps");
    container.innerHTML="";

    if(!data.tasks?.length){
        container.innerHTML=`<div class="ap-empty">All improvements completed ðŸŽ‰</div>`;
        return;
    }

    data.tasks.forEach(task=>{
        const div=document.createElement("div");
        div.className="ap-step";

        div.innerHTML=`
            <div>
                <h4>${task.title}</h4>
                <p>${task.description}</p>
                <div class="ap-impact">+${task.points} Points</div>
            </div>
        `;

        const btn=document.createElement("button");
        btn.className="ap-btn";
        btn.type="button";
        btn.textContent="Start";
        btn.onclick=()=>openTask(task.key,task.type,task.document_type||"",task.points);

        div.appendChild(btn);
        container.appendChild(div);
    });
}

function openTask(key,type,docType,points){

    const modal=document.getElementById("apModal");
    const content=document.getElementById("apModalContent");

    if(type==="strategic"){
        content.innerHTML=`
            <h3>Strategic Improvement</h3>
            <p style="color:#a9b4d6;margin-bottom:20px;">
                Update your assessment inputs to improve this category.
            </p>
            <div class="modal-actions">
                <button class="ap-btn" onclick="closeModal()">Got It</button>
            </div>
        `;
    }

    else{
        content.innerHTML=`
            <h3>Upload File</h3>
            <input type="file" id="fileInput">
            <div class="modal-actions">
                <button class="ap-btn" onclick="handleUpload('${type}','${docType}',${points})">
                    Upload & Complete
                </button>
            </div>
        `;
    }

    modal.style.display="flex";
}

async function handleUpload(type,docType,points){

    const file=document.getElementById("fileInput").files[0];
    if(!file) return;

    const formData=new FormData();
    formData.append("file",file);
    if(docType) formData.append("document_type",docType);

    let url="";
    if(type==="document") url=`/upload-document/${selectedAssessment}/`;
    if(type==="reference") url=`/add-reference/${selectedAssessment}/`;
    if(type==="cover_letter") url=`/save-cover-letter/${selectedAssessment}/`;

    await fetch(url,{
        method:"POST",
        credentials:"same-origin",
        headers:{"X-CSRFToken":getCSRFToken()},
        body:formData
    });

    showSuccess(points);
    loadTasks();
}

function closeModal(){
    document.getElementById("apModal").style.display="none";
}

document.getElementById("refreshBtn").onclick=loadTasks;
document.addEventListener("DOMContentLoaded",loadAssessments);
</script>

{% endblock %}